{% comment %} <!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Add Employee | Office EMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h3 class="text-center mb-4">Add an Employee</h3>

              {% if messages %}
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
              {% endif %}

              <form action="{% url 'add_emp' %}" method="post" autocomplete="off">
                {% csrf_token %}

                <div class="mb-3">
                  <label for="first_name" class="form-label">First Name</label>
                  <input type="text" class="form-control" id="first_name" name="first_name" placeholder="Enter first name" required>
                </div>

                <div class="mb-3">
                  <label for="last_name" class="form-label">Last Name</label>
                  <input type="text" class="form-control" id="last_name" name="last_name" placeholder="Enter last name">
                </div>

                <div class="mb-3">
                  <label for="salary" class="form-label">Salary</label>
                  <input type="number" class="form-control" id="salary" name="salary" placeholder="Enter salary" required min="0">
                </div>

                <div class="mb-3">
                  <label for="dept" class="form-label">Department</label>
                  <select class="form-select" id="dept" name="dept" required>
                    <option value="">-- Select Department --</option>
                    {% for d in departments %}
                      <option value="{{ d.id }}">{{ d.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="role" class="form-label">Role</label>
                  <select class="form-select" id="role" name="role" required>
                    <option value="">-- Select Role --</option>
                    {% for r in roles %}
                      <option value="{{ r.id }}">{{ r.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label for="bonus" class="form-label">Bonus</label>
                  <input type="number" class="form-control" id="bonus" name="bonus" placeholder="Enter bonus amount" min="0">
                </div>

                <div class="mb-3">
                  <label for="phone" class="form-label">Phone</label>
                  <input type="tel" class="form-control" id="phone" name="phone" placeholder="Enter phone number" required>
                </div>

                <div class="mb-3">
                  <label for="hire_date" class="form-label">Hire Date</label>
                  <input type="date" class="form-control" id="hire_date" name="hire_date">
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">Submit</button>
                </div>
              </form>

              <div class="mt-3">
                <a href="{% url 'all_emp' %}" class="btn btn-secondary">View All Employees</a>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html> {% endcomment %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Add Employee | Office EMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; }
    .card { border: none; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); overflow: hidden; }
    .card-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2rem; text-align: center; }
    .btn-submit { background: linear-gradient(135deg, #1199ff, #667eea); border: none; padding: 14px; font-weight: bold; border-radius: 50px; font-size: 1.1rem; }
    .form-control, .form-select { border-radius: 12px; padding: 12px; }
  </style>
</head>
<body>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-5 col-md-7">
      <div class="card">
        <div class="card-header">
          <h2 class="mb-0">Add New Employee</h2>
        </div>
        <div class="card-body p-5">
          <form id="addForm">
            <!-- तुम्हारा पूरा form same रहेगा -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">First Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control form-control-lg" id="first_name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Last Name</label>
                <input type="text" class="form-control form-control-lg" id="last_name">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Salary <span class="text-danger">*</span></label>
                <input type="number" class="form-control form-control-lg" id="salary" required min="0">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Bonus</label>
                <input type="number" class="form-control form-control-lg" id="bonus" min="0">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Department <span class="text-danger">*</span></label>
                <select class="form-select form-select-lg" id="dept" required><option>Loading...</option></select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Role <span class="text-danger">*</span></label>
                <select class="form-select form-select-lg" id="role" required><option>Loading...</option></select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Phone <span class="text-danger">*</span></label>
              <input type="tel" class="form-control form-control-lg" id="phone" required>
            </div>
            <div class="mb-4">
              <label class="form-label fw-bold">Hire Date</label>
              <input type="date" class="form-control form-control-lg" id="hire_date">
            </div>

            <button type="submit" class="btn btn-primary btn-lg w-100 btn-submit" id="submitBtn">
              <span class="spinner-border spinner-border-sm me-2 d-none" id="spinner"></span>
              Add Employee
            </button>
          </form>
          <div class="text-center mt-4">
            <a href="/all_emp/" class="btn btn-outline-light btn-lg">View All Employees</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// YE SCRIPT SABSE UPAR HAI — 100% GUARANTEED FIX
const API_BASE = "http://127.0.0.1:8000/api/";

// SABSE PEHLE TOKEN CHECK — AGAR GALAT HAI TO TURANT LOGIN PE BHEJEGA
(async () => {
    const access = localStorage.getItem('accessToken');
    const refresh = localStorage.getItem('refreshToken');

    // Agar koi token nahi → direct login
    if (!access && !refresh) {
        location.replace("/login/");
        return;
    }

    // Token test karo
    const test = async (token) => {
        try {
            const r = await fetch(`${API_BASE}employees/`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            return r.ok;
        } catch { return false; }
    };

    // Pehle access token try karo
    if (access && await test(access)) return;

    // Phir refresh try karo
    if (refresh) {
        try {
            const r = await fetch(`${API_BASE}token/refresh/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh })
            });
            if (r.ok) {
                const d = await r.json();
                localStorage.setItem('accessToken', d.access);
                return; // ab sahi hai
            }
        } catch {}
    }

    // Agar dono fail → SAB DELETE KARKE LOGIN PE BHEJO
    localStorage.clear();
    alert("Your session has expired. Please login again.");
    location.replace("/login/");
})();

// Baaki sab code same — sirf API helper thoda simple kiya
async function api(url, opt = {}) {
    opt.headers = opt.headers || {};
    opt.headers.Authorization = `Bearer ${localStorage.getItem('accessToken')}`;
    if (opt.body && typeof opt.body === 'object') {
        opt.headers['Content-Type'] = 'application/json';
        opt.body = JSON.stringify(opt.body);
    }
    const res = await fetch(url, opt);
    if (res.status === 401) { localStorage.clear(); location.replace("/login/"); }
    return res;
}

// Load departments & roles
async function loadData() {
    const [d, r] = await Promise.all([
        api(`${API_BASE}departments/`).then(x => x.json()),
        api(`${API_BASE}roles/`).then(x => x.json())
    ]);
    const dept = document.getElementById('dept');
    const role = document.getElementById('role');
    dept.innerHTML = '<option value="">-- Select Department --</option>';
    role.innerHTML = '<option value="">-- Select Role --</option>';
    d.forEach(x => dept.add(new Option(x.name, x.id)));
    r.forEach(x => role.add(new Option(x.name, x.id)));
}
loadData();

// Form submit
document.getElementById('addForm').onsubmit = async e => {
    e.preventDefault();
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('spinner').classList.remove('d-none');

    const payload = {
        first_name: document.getElementById('first_name').value.trim(),
        last_name: document.getElementById('last_name').value.trim() || null,
        salary: +document.getElementById('salary').value,
        bonus: +document.getElementById('bonus').value || 0,
        dept: +document.getElementById('dept').value,
        role: +document.getElementById('role').value,
        phone: document.getElementById('phone').value.trim(),
        hire_date: document.getElementById('hire_date').value || null
    };

    const res = await api(`${API_BASE}employees/`, { method: 'POST', body: payload });
    if (res.ok) {
        alert("Employee added successfully!");
        location.href = "/all_emp/";
    } else {
        const err = await res.json();
        alert("Error: " + (err.detail || JSON.stringify(err)));
    }
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('spinner').classList.add('d-none');
};
</script>
</body>
</html>